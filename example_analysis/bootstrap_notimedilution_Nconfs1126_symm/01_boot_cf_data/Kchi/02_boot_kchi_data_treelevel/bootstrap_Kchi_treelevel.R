##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##

#--------------------------------------------------------------------------------------------------------#
#   LOAD PACKAGES AND CODE FOR ANALYSIS                                                                  #
#--------------------------------------------------------------------------------------------------------#
library(dplyr)                                                     ## required for filter()
devtools::load_all("/home/nikolas/Software/hadron")                ## required for new_matrixfit()
source("/home/nikolas/Documents/NPV/njjn_analysis/GRADIENT_FLOW/mixing_probe_src_oet_GRADFLOW/GRADFLOW_ANALYSIS/R_Code/kchi_and_c2pt_gf.R") ## load R functions required for this kchi-analysis

##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##

#========================================================================================================#
#                                                                                                        #
#   BOOTSTRAP FOR ANALYSIS:                                                                              #
#                                                                                                        #
#   * Extract gradflow time from K_\chi data files in h5 format                                          #
#   * Read K_\chi data files in h5 format                                                                #
#   * Calculate Z_\chi = (-2*Nc*Nf) / K_\chi                                                             #
#   * Bootstrap Z_\chi data                                                                              #
#                                                                                                        #
#========================================================================================================#

Nconfigs <- 1
my_Nsamples <- 10
my_conf <- 0

VOLUME <- 64 * 32^3
Nc <- 3   ## number of colors (r, g, b)
Nf <- 1   ## number of flavors 1 because u or d

mypath <- "/home/nikolas/Documents/NPV/njjn_analysis/GRADIENT_FLOW/mixing_probe_src_oet_GRADFLOW/GRADFLOW_DATA/06_qbig_kchi_data_Nsamples10_treelevel/idgauge_kinetic_op_gf_treelevel"
my_gft <- c(0.00,0.01,0.02,0.03,0.04,0.05,0.06,0.07,0.08,0.09,0.10,0.11,0.12,0.13,0.14,0.15,0.16,0.17,0.18,0.19,0.20)


##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##

print(paste0("Start reading (VOLUME * Kchi) data files in h5 format for Nsamples = ", my_Nsamples))

#--------------------------------------------------------------------------------------------------------#
#   Read (VOLUME * K_\chi) data files in h5 format                                                       #
#--------------------------------------------------------------------------------------------------------#
print("Read (VOLUME * Kchi) data files in h5 format")

VOLUME_Kchi_data    <- array( rep(NA, length(my_conf)*length(my_gft)), dim=c(length(my_gft),length(my_conf)) )
VOLUME_Kchi_data_up <- array( rep(NA, length(my_conf)*length(my_gft)), dim=c(length(my_gft),length(my_conf)) )
VOLUME_Kchi_data_dn <- array( rep(NA, length(my_conf)*length(my_gft)), dim=c(length(my_gft),length(my_conf)) )

gfdata <- read.h5.gf.new( path=mypath,
                          basename_start="test_gf.c",
                          basename_end=".h5",
                          conflist=my_conf,
                          tvec=my_gft,
                          Nsamples = my_Nsamples )

VOLUME_Kchi_data_re <- analysis.gf.new( tvec=my_gft,
                                        x=gfdata,
                                        Nsamples=my_Nsamples,
                                        icplx=1,
                                        err="sd",
                                        format="h5" )

VOLUME_Kchi_data_im <- analysis.gf.new( tvec=my_gft,
                                        x=gfdata,
                                        Nsamples=my_Nsamples,
                                        icplx=2,
                                        err="sd",
                                        format="h5" )


## only consider K_\chi data "VOLUME_Kchi_data_re[[5]]" and "VOLUME_Kchi_data_im[[5]]"
## where we have averaged over
##    * samples,
##    * mu-values,
##    * flavors
## Thus, VOLUME_Kchi_data_re[[5]] contains one single vector of length "length(my_gft)"
## These results are stored as complex numbers in the array "VOLUME_Kchi_data"
Kchi_treelevel_data <- complex( real      = -0.5*VOLUME_Kchi_data_re[[5]]/VOLUME,
                                imaginary = -0.5*VOLUME_Kchi_data_im[[5]]/VOLUME )

## now also consider K_\chi data "VOLUME_Kchi_data_re[[4]]" and "VOLUME_Kchi_data_im[[4]]"
## where we have averaged over
##    * samples,
##    * mu-values.
## Thus, VOLUME_Kchi_data_re[[4]] contains two vectors of length "length(my_gft)", namely
##    * "VOLUME_Kchi_data_re[[4]][,1,1]" for flavor "up" and
##    * "VOLUME_Kchi_data_re[[4]][,2,1]" for flavor "down".
## These results are stored as complex numbers in the arrays
##    * "VOLUME_Kchi_data_up" and
##    * "VOLUME_Kchi_data_dn"
Kchi_treelevel_data_up <- complex(      real = -0.5*VOLUME_Kchi_data_re[[4]][,1,1]/VOLUME,
                                   imaginary = -0.5*VOLUME_Kchi_data_im[[4]][,1,1]/VOLUME )

Kchi_treelevel_data_dn <- complex(      real = -0.5*VOLUME_Kchi_data_re[[4]][,2,1]/VOLUME,
                                   imaginary = -0.5*VOLUME_Kchi_data_im[[4]][,2,1]/VOLUME )


##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
print("Start saving the workspace image")

#--------------------------------------------------------------------------------------------------------#
#   SAVE WORKSPACE IMAGE                                                                                 #
#--------------------------------------------------------------------------------------------------------#
save.image( file = paste0("bootstrap_Kchi_Nconfs", Nconfigs, "_Nsamples", my_Nsamples, "_treelevel.RData") )

##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##
##==================================================================================================================================================================================================================================##